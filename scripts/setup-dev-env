#!/usr/bin/env bash

set -eux

cd "${0%/*}/.."

# Install nix
if ! ls /nix &> /dev/null; then
  curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux \
    --extra-conf "sandbox = false" \
    --init none \
    --no-confirm
  export PATH="${PATH}:/nix/var/nix/profiles/default/bin"
  echo 'export PATH="${PATH}:/nix/var/nix/profiles/default/bin"' > ~/.bashrc
fi

sudo -i nix develop -c bash << MEOW 
npm install;
pushd auth;
cargo build;
popd;
pushd client;
npm install;
popd;
pushd terminal-client;
npm install;
popd;
git submodule init;
git submodule update;
pushd game/prometheus-cpp;
git submodule init;
git submodule update;
mkdir -p _build;
cd _build;
cmake .. -DBUILD_SHARED_LIBS=ON -DENABLE_PUSH=OFF -DENABLE_COMPRESSION=OFF;
cmake --build . --parallel 4;
cmake --install .;
ldconfig;
MEOW
